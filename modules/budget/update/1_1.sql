-- Aggiunte query per previsionale ordini cliente e ordini fornitore
INSERT INTO `bu_sorgenti` (`nome`, `sezionale`, `query`, `query2`, `enabled`) VALUES
('Ordini cliente', 'vendite', 'SELECT \r\n ( ( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) ) AS totale,\r\n CONCAT(\'Ordine cliente \', `or_ordini`.`numero_esterno`, \': \', `or_righe_ordini`.`descrizione`) AS descrizione, \r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`)) AS data,\r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `or_righe_ordini` \r\nINNER JOIN \r\n `or_ordini` \r\nON\r\n `or_ordini`.`id`=`or_righe_ordini`.`idordine` \r\nINNER JOIN \r\n `an_anagrafiche`\r\nON \r\n an_anagrafiche.idanagrafica=or_ordini.idanagrafica\r\nINNER JOIN\r\n `or_tipiordine`\r\nON or_ordini.idtipoordine=or_tipiordine.id\r\nWHERE \r\n LAST_DAY( IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`)) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n or_tipiordine.dir=\'entrata\'\r\n AND\r\n NOT `or_righe_ordini`.`is_descrizione`=1\r\n AND\r\n `or_righe_ordini`.`confermato`=1\r\nAND\r\n NOT (`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) = 0', 'SELECT \r\n (( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)+( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)/100*IFNULL(co_iva.percentuale, \'|iva_predefinita|\' )) AS totale,\r\n CONCAT(\'Ordine cliente \', `or_ordini`.`numero_esterno`, \': \', `or_righe_ordini`.`descrizione`) AS descrizione, \r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) AS data,\r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `or_righe_ordini` \r\n INNER JOIN `or_ordini` ON `or_ordini`.`id`=`or_righe_ordini`.`idordine` \r\n INNER JOIN `an_anagrafiche`ON an_anagrafiche.idanagrafica=or_ordini.idanagrafica\r\n LEFT JOIN co_iva ON co_iva.id=an_anagrafiche.idiva_vendite\r\n LEFT JOIN co_pagamenti ON an_anagrafiche.idpagamento_vendite=co_pagamenti.id\r\n LEFT JOIN co_pagamenti AS pagamenti2 ON co_pagamenti.descrizione=pagamenti2.descrizione\r\nINNER JOIN\r\n `or_tipiordine`\r\nON or_ordini.idtipoordine=or_tipiordine.id\r\nWHERE \r\n LAST_DAY( IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n NOT `or_righe_ordini`.`is_descrizione`=1\r\n AND\r\n or_tipiordine.dir=\'entrata\'\r\n AND\r\n `or_righe_ordini`.`confermato`=1\r\nAND\r\n NOT (`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) = 0', 1),
('Ordini fornitore', 'acquisti', 'SELECT \r\n -( ( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) ) AS totale,\r\n CONCAT(\'Ordine fornitore \', `or_ordini`.`numero`, \': \', `or_righe_ordini`.`descrizione`) AS descrizione, \r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`)) AS data,\r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `or_righe_ordini` \r\nINNER JOIN \r\n `or_ordini` \r\nON\r\n `or_ordini`.`id`=`or_righe_ordini`.`idordine` \r\nINNER JOIN \r\n `an_anagrafiche`\r\nON \r\n an_anagrafiche.idanagrafica=or_ordini.idanagrafica\r\nINNER JOIN\r\n `or_tipiordine`\r\nON or_ordini.idtipoordine=or_tipiordine.id\r\nWHERE \r\n LAST_DAY( IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`)) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n or_tipiordine.dir=\'uscita\'\r\n AND\r\n NOT `or_righe_ordini`.`is_descrizione`=1\r\n AND\r\n `or_righe_ordini`.`confermato`=1\r\nAND\r\n NOT (`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) = 0', 'SELECT \r\n -(( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)+( (`or_righe_ordini`.`subtotale`-`or_righe_ordini`.`sconto`)/`or_righe_ordini`.`qta`)*(`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)/100*IFNULL(co_iva.percentuale, \'|iva_predefinita|\' )) AS totale,\r\n CONCAT(\'Ordine fornitore \', `or_ordini`.`numero`, \': \', `or_righe_ordini`.`descrizione`) AS descrizione, \r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) AS data,\r\n IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `or_righe_ordini` \r\n INNER JOIN `or_ordini` ON `or_ordini`.`id`=`or_righe_ordini`.`idordine` \r\n INNER JOIN `an_anagrafiche`ON an_anagrafiche.idanagrafica=or_ordini.idanagrafica\r\n LEFT JOIN co_iva ON co_iva.id=an_anagrafiche.idiva_vendite\r\n LEFT JOIN co_pagamenti ON an_anagrafiche.idpagamento_vendite=co_pagamenti.id\r\n LEFT JOIN co_pagamenti AS pagamenti2 ON co_pagamenti.descrizione=pagamenti2.descrizione\r\nINNER JOIN\r\n `or_tipiordine`\r\nON or_ordini.idtipoordine=or_tipiordine.id\r\nWHERE \r\n LAST_DAY( IF( IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), IFNULL(`or_righe_ordini`.`data_evasione`, `or_ordini`.`data`) + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n NOT `or_righe_ordini`.`is_descrizione`=1\r\n AND\r\n or_tipiordine.dir=\'uscita\'\r\n AND\r\n `or_righe_ordini`.`confermato`=1\r\nAND\r\n NOT (`or_righe_ordini`.`qta`-`or_righe_ordini`.`qta_evasa`) = 0', 1);

-- Aggiunta sorgente scadenzario
INSERT INTO `bu_sorgenti` (`id`, `nome`, `sezionale`, `query`, `query2`, `enabled`) VALUES 
(NULL, 'Vendita', 'vendite', '', 'SELECT\r\n (da_pagare-pagato) AS totale,\r\n co_scadenziario.descrizione,\r\n (SELECT an_anagrafiche.ragione_sociale FROM an_anagrafiche INNER JOIN co_documenti ON co_documenti.idanagrafica=an_anagrafiche.idanagrafica WHERE co_documenti.id=co_scadenziario.iddocumento) AS anagrafica,\r\n co_scadenziario.scadenza AS `data`\r\nFROM\r\n co_scadenziario\r\nWHERE\r\n MONTH(IF(co_scadenziario.scadenza<=CURDATE(), CURDATE(), co_scadenziario.scadenza)) = \'|mese|\'\r\n AND\r\n YEAR(IF(co_scadenziario.scadenza<=CURDATE(), CURDATE(), co_scadenziario.scadenza)) = \'|anno|\'\r\nHAVING\r\n totale > 0', '1'), 
(NULL, 'Acquisti', 'acquisti', '', 'SELECT\r\n (da_pagare-pagato) AS totale,\r\n co_scadenziario.descrizione,\r\n (SELECT an_anagrafiche.ragione_sociale FROM an_anagrafiche INNER JOIN co_documenti ON co_documenti.idanagrafica=an_anagrafiche.idanagrafica WHERE co_documenti.id=co_scadenziario.iddocumento) AS anagrafica,\r\n co_scadenziario.scadenza AS `data`\r\nFROM\r\n co_scadenziario\r\nWHERE\r\n MONTH(IF(co_scadenziario.scadenza<=CURDATE(), CURDATE(), co_scadenziario.scadenza)) = \'|mese|\'\r\n AND\r\n YEAR(IF(co_scadenziario.scadenza<=CURDATE(), CURDATE(), co_scadenziario.scadenza)) = \'|anno|\'\r\nHAVING\r\n totale < 0', '1');

-- Aggiunta sorgente ddt di vendita
INSERT INTO `bu_sorgenti` (`id`, `nome`, `sezionale`, `query`, `query2`, `enabled`) VALUES
(NULL, 'Ddt di vendita', 'vendite', 'SELECT \r\n ( ( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) ) AS totale,\r\n CONCAT(\'Ddt in uscita \', `dt_ddt`.`numero`, \': \', `dt_righe_ddt`.`descrizione`) AS descrizione, \r\n IF( `dt_ddt`.`data` < CURDATE(), CURDATE(), `dt_ddt`.`data`) AS data,\r\n IF( `dt_ddt`.`data` < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `dt_righe_ddt` \r\nINNER JOIN \r\n `dt_ddt` \r\nON\r\n `dt_ddt`.`id`=`dt_righe_ddt`.`idddt` \r\nINNER JOIN \r\n `an_anagrafiche`\r\nON \r\n an_anagrafiche.idanagrafica=dt_ddt.idanagrafica\r\nINNER JOIN\r\n `dt_tipiddt`\r\nON dt_ddt.idtipoddt=dt_tipiddt.id\r\nWHERE \r\n LAST_DAY( IF( `dt_ddt`.`data` < CURDATE(), CURDATE(), `dt_ddt`.`data`) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n dt_tipiddt.dir=\'entrata\'\r\n AND\r\n NOT `dt_righe_ddt`.`is_descrizione`=1\r\nAND\r\n NOT (`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) = 0', 'SELECT \r\n (( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)+( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)/100*IFNULL(co_iva.percentuale, \'|iva_predefinita|\' )) AS totale,\r\n CONCAT(\'Ddt in uscita \', `dt_ddt`.`numero`, \': \', `dt_righe_ddt`.`descrizione`) AS descrizione, \r\n IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) AS data,\r\n IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `dt_righe_ddt` \r\n INNER JOIN `dt_ddt` ON `dt_ddt`.`id`=`dt_righe_ddt`.`idddt` \r\n INNER JOIN `an_anagrafiche`ON an_anagrafiche.idanagrafica=dt_ddt.idanagrafica\r\n LEFT JOIN co_iva ON co_iva.id=an_anagrafiche.idiva_vendite\r\n LEFT JOIN co_pagamenti ON an_anagrafiche.idpagamento_vendite=co_pagamenti.id\r\n LEFT JOIN co_pagamenti AS pagamenti2 ON co_pagamenti.descrizione=pagamenti2.descrizione\r\nINNER JOIN\r\n `dt_tipiddt`\r\nON dt_ddt.idtipoddt=dt_tipiddt.id\r\nWHERE \r\n LAST_DAY( IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n NOT `dt_righe_ddt`.`is_descrizione`=1\r\n AND\r\n dt_tipiddt.dir=\'entrata\'\r\nAND\r\n NOT (`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) = 0', 1);
INSERT INTO `bu_sorgenti` (`id`, `nome`, `sezionale`, `query`, `query2`, `enabled`) VALUES
(NULL, 'Ddt di acquisto', 'acquisti', 'SELECT \r\n -( ( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) ) AS totale,\r\n CONCAT(\'Ddt in entrata \', `dt_ddt`.`numero`, \': \', `dt_righe_ddt`.`descrizione`) AS descrizione, \r\n IF( `dt_ddt`.`data` < CURDATE(), CURDATE(), `dt_ddt`.`data`) AS data,\r\n IF( `dt_ddt`.`data` < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `dt_righe_ddt` \r\nINNER JOIN \r\n `dt_ddt` \r\nON\r\n `dt_ddt`.`id`=`dt_righe_ddt`.`idddt` \r\nINNER JOIN \r\n `an_anagrafiche`\r\nON \r\n an_anagrafiche.idanagrafica=dt_ddt.idanagrafica\r\nINNER JOIN\r\n `dt_tipiddt`\r\nON dt_ddt.idtipoddt=dt_tipiddt.id\r\nWHERE \r\n LAST_DAY( IF( `dt_ddt`.`data` < CURDATE(), CURDATE(), `dt_ddt`.`data`) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n dt_tipiddt.dir=\'uscita\'\r\n AND\r\n NOT `dt_righe_ddt`.`is_descrizione`=1\r\nAND\r\n NOT (`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) = 0', 'SELECT \r\n -(( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)+( (`dt_righe_ddt`.`subtotale`-`dt_righe_ddt`.`sconto`)/`dt_righe_ddt`.`qta`)*(`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`)*IFNULL(pagamenti2.prc/100, 1)/100*IFNULL(co_iva.percentuale, \'|iva_predefinita|\' )) AS totale,\r\n CONCAT(\'Ddt in ingresso \', `dt_ddt`.`numero`, \': \', `dt_righe_ddt`.`descrizione`) AS descrizione, \r\n IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) AS data,\r\n IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), 1, 0) AS scaduto,\r\n an_anagrafiche.ragione_sociale AS anagrafica\r\nFROM \r\n `dt_righe_ddt` \r\n INNER JOIN `dt_ddt` ON `dt_ddt`.`id`=`dt_righe_ddt`.`idddt` \r\n INNER JOIN `an_anagrafiche`ON an_anagrafiche.idanagrafica=dt_ddt.idanagrafica\r\n LEFT JOIN co_iva ON co_iva.id=an_anagrafiche.idiva_vendite\r\n LEFT JOIN co_pagamenti ON an_anagrafiche.idpagamento_vendite=co_pagamenti.id\r\n LEFT JOIN co_pagamenti AS pagamenti2 ON co_pagamenti.descrizione=pagamenti2.descrizione\r\nINNER JOIN\r\n `dt_tipiddt`\r\nON dt_ddt.idtipoddt=dt_tipiddt.id\r\nWHERE \r\n LAST_DAY( IF( `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY < CURDATE(), CURDATE(), `dt_ddt`.`data` + INTERVAL IFNULL(pagamenti2.num_giorni, 0) DAY) ) = LAST_DAY(\'|anno|-|mese|-01\')\r\n AND\r\n NOT `dt_righe_ddt`.`is_descrizione`=1\r\n AND\r\n dt_tipiddt.dir=\'uscita\'\r\nAND\r\n NOT (`dt_righe_ddt`.`qta`-`dt_righe_ddt`.`qta_evasa`) = 0', 1);
